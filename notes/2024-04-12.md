---
id: "2024-04-12"
aliases: []
tags: []
---

# 月度报告

## 我当前的工作职责和工作内容是什么

当前我的工作职责是负责 buddy mlir 的后端部分的开发工作。
具体而言目标集中于给 buddy 编译器团队提供两个 RVV 的硬件环境：
chipsalliance 的 T1 硬件，负责给编译器团队一个模拟的 32 位 rvv 仿真环境。
以及 SiFive 的 FPGA，用于给编译器团队提供一个真实的 64 位 rvv 硬件。

## 需求和挑战

我将在这一节细谈这个季度的工作内容和工作时遇到的挑战，我是如何解决这些需求的，
以及在这个过程中我都学到了什么。

### SiFive (___)

SiFive 的 FPGA 板子的需求是起一个正常的 Linux Kernel，让 buddy mlir 小队的成员们
都能远程访问到这块板子，然后在上面跑 Buddy MLIR 的测试，获得对应需要的性能数据。
我手上有的仅有一块 VCU118 FPGA 板子和一个 SiFive 提供的 bitstream 文件，
以及一个完整 dd 出来的系统镜像文件。

最开始的想法是按 SiFive 设计的，利用 FPGA 板子上已有的 PMOD 插槽，找国内的厂商
帮忙定做了一个 PMOD to SD 转换器，将镜像烧在 SD 卡上来启动系统。

但是事与愿违，等了将近半个月的 PMOD 转换卡，到手后却发现 SiFive 寄出的 FPGA 板子的
PMOD 插槽是坏的。于是立刻转变方向，靠直接烧 OpenSBI payload 到 DDR 上来启动镜像。
通过解包系统镜像，我拿到了这块板子的 dtb 文件，转译回 dts 文件之后，
拿到了绝大部分硬件的内存地址，比如 MMIO，DDR 的地址。

有了设备树之后，参照着 xilinx 目前在 uboot 里已有的 vcu118 的设备信息，
我 fork 了一份 uboot ，添加了设备信息，编译了一份给这个 fpga 的 uboot.bin。
然后用默认 config 编译了一份 Linux 镜像，放进 opensbi 的 payload 里。

接下来就是将 FPGA 板子的 UART 和 JTAG 接到电脑上，用 openocd 连 JTAG 起 GDB server
调试硬件，用 picocom 连 UART 拿 MMIO 的输出。
具体调试的方式是在宿主机上跑 riscv64 的 gdb，连上 openocd 起的 GDB server。
由于上面提到我已经知道了 DDR 的内存地址，将 uboot 和带着 Linux kernel 的 opensbi payload 固件，
用 gdb 的 restore binary 指令将这些文件写到对应的内存地址上，然后 set PC 并跳转来启动 uboot。

目前 kernel 已经能正常启动了，但是不知道是 kernel 的驱动问题还是设备树的正确性问题，
现在网络的 tx 是正常的，rx 还是坏的，准备进一步调试。

### chipsalliance/t1

目前 T1 已经进入稳定状态，正在收时序的阶段。我在这段时间建立了一套完整的 RTL 到后端的工作流，
以及一套面向开源社区的交付自动化工作流，和一套基于开源社区的，面向商业客户的工作流。

T1 的项目设计是对多 lane 和 vlen 做支持，以及支持可选的浮点支持。
这随之带来了几个需求：

* 要有通用的配置，指导 Chisel 生成对应的 RTL

目前已有的开源交付对象有 Buddy MLIR，rvv-benchmark 两个社区，对两者都交付 dlen 256 vlen 512 的
配置。商业交付还有 vlen 1024 的交付。除了不同的 lane 和 vlen 的配置，还有大量不同的延时配置，
这些配置最后会生成不同的 RTL，再喂给 verilator 编译出不同的仿真模拟器。
需要为所有的配置综合出一套统一的交付流程和交付文档。

* 需要减少交付对象的操作复杂度和操作流程

在 chipsalliance/t1 内，有着大量复杂的依赖，从用于生成配置，RTL 的 Scala 和其对应的依赖，
用于编写模拟器的 C++ 和其对应的依赖，测试用例的 C 和 riscv 工具链，以及 buddy mlir 的 llvm 工具链。
虽然我用 nix 保证整个项目是完全可复现的，但实际这样复杂的环境，加上 nix 本身的复杂性，
将整个项目源码交付给客户，让交付对象自己复现是不现实的。

* 交付要能满足高速迭代的需求

虽然目前 RTL 已经不会再有大的变更，但是现在 T1 为了达到更高频率而在不断做小更改。
交付需求是现在做了一个小的优化，五分钟之后客户就能拿到全新的仿真环境，为此我需要给 T1 做一套自动化流程。

## 下个月开始的工作计划和个人提升的计划

