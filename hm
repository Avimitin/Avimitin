#!/bin/bash

flag=$1; shift
[[ -z "$flag" ]] \
  && echo "Missing operation" \
  && exit 1

NIX_FLAGS=(
  --extra-experimental-features "flakes nix-command"
)
HM_FLAGS=(
  --extra-experimental-features "flakes nix-command"
  --show-trace
)

operation=""

while true; do
  case $flag in
    s|sw|switch)
      operation="switch"
      home=$1; shift
      HM_FLAGS+=( --flake ".?submodules=1#$home" )
      flag="foo-bar-baz"
      ;;
    expire|clean|expire-generations)
      operation="expire-generations"
      flag="foo-bar-baz"
      ;;
    l|list|generations)
      operation="generations"
      flag="foo-bar-baz"
      ;;
    --offline)
      NIX_FLAGS+=( --offline )
      flag="$1"
      shift 1
      ;;
    *)
      break
  esac
done

if (( $HM_DEBUG )); then
  echo "NIX_FLAGS: ${NIX_FLAGS[@]}"
  echo "HM_FLAGS: ${HM_FLAGS[@]}"
  echo "Operation: $operation"
  echo "Other opts: $@"
fi

nix "${NIX_FLAGS[@]}" run .#home-manager -- "${HM_FLAGS[@]}" "$operation" "$@"
